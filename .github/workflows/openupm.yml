name: Publish to OpenUPM

on:
  push:
    tags:
      - '*'      

jobs:
  publish:
    name: Publish Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Validação básica do package.json
      #    Isso evita publicação corrompida (nome errado, versão faltando, etc.)
      - name: Validate package.json
        run: |
          if [ ! -f package.json ]; then
            echo "ERRO: package.json não encontrado no root do repositório."
            exit 1
          fi

          PKG_NAME=$(jq -r '.name' package.json)
          if [ "$PKG_NAME" != "com.ale.unity-startup" ]; then
            echo "ERRO: Nome do pacote no package.json não confere: $PKG_NAME"
            exit 1
          fi

          echo "package.json validado com sucesso."

      # 4. Publicação pelo OpenUPM (ação oficial)
      - name: Publish to OpenUPM
        uses: openupm/openupm-publish-action@v1
        with:
          package-name: com.ale.unity-startup
          github-token: ${{ secrets.GITHUB_TOKEN }}
